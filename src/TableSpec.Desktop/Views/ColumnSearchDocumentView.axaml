<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:vm="using:TableSpec.Desktop.ViewModels"
             xmlns:domain="using:TableSpec.Domain.Entities"
             xmlns:converters="using:TableSpec.Desktop.Converters"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             mc:Ignorable="d" d:DesignWidth="1200" d:DesignHeight="700"
             x:Class="TableSpec.Desktop.Views.ColumnSearchDocumentView"
             x:DataType="vm:ColumnSearchDocumentViewModel">

    <UserControl.Resources>
        <converters:ConsistencyLevelToColorConverter x:Key="LevelToColorConverter"/>
        <converters:ConsistencyLevelToForegroundConverter x:Key="LevelToForegroundConverter"/>
        <converters:TypeInconsistentToColorConverter x:Key="InconsistentToColorConverter"/>
        <converters:InverseBoolConverter x:Key="InverseBoolConverter"/>
        <converters:ConstraintCountToTextConverter x:Key="ConstraintCountConverter"/>
        <converters:BoolToYesNoConverter x:Key="BoolToYesNoConverter"/>
    </UserControl.Resources>

    <Design.DataContext>
        <vm:ColumnSearchDocumentViewModel/>
    </Design.DataContext>

    <Grid RowDefinitions="Auto,*,Auto">
        <!-- å·¥å…·åˆ— -->
        <Border Grid.Row="0" Background="{DynamicResource SystemControlBackgroundChromeMediumBrush}" Padding="10,8">
            <Grid ColumnDefinitions="Auto,*,Auto">
                <!-- å·¦å´ï¼šé€£ç·šé¸æ“‡ -->
                <StackPanel Grid.Column="0" Orientation="Horizontal" Spacing="10">
                    <TextBlock Text="é€£ç·šï¼š" VerticalAlignment="Center"/>
                    <ComboBox MinWidth="180" VerticalAlignment="Center"
                              ItemsSource="{Binding ConnectionProfiles}"
                              SelectedItem="{Binding SelectedProfile}">
                        <ComboBox.ItemTemplate>
                            <DataTemplate x:DataType="domain:ConnectionProfile">
                                <TextBlock Text="{Binding Name}"/>
                            </DataTemplate>
                        </ComboBox.ItemTemplate>
                    </ComboBox>
                </StackPanel>

                <!-- ä¸­é–“ï¼šæœå°‹ -->
                <StackPanel Grid.Column="1" Orientation="Horizontal" Spacing="10" Margin="20,0">
                    <TextBlock Text="æ¬„ä½åç¨±ï¼š" VerticalAlignment="Center"/>
                    <TextBox Text="{Binding ColumnSearchText}"
                             Width="250"
                             Watermark="è¼¸å…¥æ¬„ä½åç¨±é—œéµå­—..."/>
                    <Button Command="{Binding SearchColumnsCommand}"
                            IsEnabled="{Binding !IsSearching}">
                        <StackPanel Orientation="Horizontal" Spacing="5">
                            <TextBlock Text="ðŸ”" FontSize="14"/>
                            <TextBlock Text="æœå°‹"/>
                        </StackPanel>
                    </Button>
                    <Button Command="{Binding AnalyzeConsistencyCommand}"
                            IsEnabled="{Binding !IsSearching}"
                            ToolTip.Tip="åˆ†æžåŒåæ¬„ä½åœ¨ä¸åŒè³‡æ–™è¡¨ä¸­çš„åž‹æ…‹ä¸€è‡´æ€§">
                        <StackPanel Orientation="Horizontal" Spacing="5">
                            <TextBlock Text="ðŸ“Š" FontSize="14"/>
                            <TextBlock Text="åˆ†æžä¸€è‡´æ€§"/>
                        </StackPanel>
                    </Button>
                    <Button Command="{Binding ClearColumnSearchCommand}">
                        <StackPanel Orientation="Horizontal" Spacing="5">
                            <TextBlock Text="ðŸ—‘ï¸" FontSize="14"/>
                            <TextBlock Text="æ¸…é™¤"/>
                        </StackPanel>
                    </Button>
                    <ProgressBar IsIndeterminate="True" Width="80"
                                 IsVisible="{Binding IsSearching}"/>
                </StackPanel>
            </Grid>
        </Border>

        <!-- ä¸»è¦å…§å®¹å€åŸŸ -->
        <Grid Grid.Row="1" Margin="10,5">
            <!-- æœå°‹çµæžœï¼ˆæœªåˆ†æžæ™‚é¡¯ç¤ºï¼‰ -->
            <Grid RowDefinitions="*,Auto" IsVisible="{Binding !ShowTypeAnalysis}">
                <DataGrid Grid.Row="0"
                          ItemsSource="{Binding ColumnSearchResults}"
                          SelectedItem="{Binding SelectedSearchResult}"
                          AutoGenerateColumns="False"
                          IsReadOnly="True"
                          GridLinesVisibility="All"
                          CanUserResizeColumns="True"
                          CanUserReorderColumns="True"
                          CanUserSortColumns="True">
                    <DataGrid.Columns>
                        <DataGridTextColumn Header="æ¬„ä½/åƒæ•¸åç¨±" Binding="{Binding ColumnName}" Width="150"/>
                        <DataGridTextColumn Header="ç‰©ä»¶é¡žåž‹" Binding="{Binding ObjectType}" Width="120"/>
                        <DataGridTextColumn Header="Schema" Binding="{Binding SchemaName}" Width="80"/>
                        <DataGridTextColumn Header="ç‰©ä»¶åç¨±" Binding="{Binding ObjectName}" Width="200"/>
                        <DataGridTextColumn Header="è³‡æ–™åž‹åˆ¥" Binding="{Binding DataType}" Width="120"/>
                        <DataGridTextColumn Header="æ¬„ä½èªªæ˜Ž" Binding="{Binding Description}" Width="*"/>
                    </DataGrid.Columns>
                </DataGrid>

                <!-- å¥—ç”¨èªªæ˜Žå·¥å…·åˆ— -->
                <Border Grid.Row="1" Background="{DynamicResource SystemControlBackgroundChromeMediumBrush}"
                        Padding="10,8"
                        IsVisible="{Binding SelectedSearchResult, Converter={x:Static ObjectConverters.IsNotNull}}">
                    <StackPanel Orientation="Horizontal" Spacing="12">
                        <TextBlock Text="é¸ä¸­ï¼š" VerticalAlignment="Center"/>
                        <TextBlock Text="{Binding SelectedSearchResult.FullObjectName}" FontWeight="SemiBold" VerticalAlignment="Center"/>
                        <TextBlock Text="{Binding SelectedSearchResult.ColumnName, StringFormat='.[{0}]'}" VerticalAlignment="Center"/>
                        <TextBlock Text="{Binding SelectedSearchResult.Description, StringFormat='èªªæ˜Žï¼š{0}'}"
                                   VerticalAlignment="Center" MaxWidth="300" TextTrimming="CharacterEllipsis"
                                   Foreground="{DynamicResource SystemControlForegroundBaseMediumBrush}"/>
                        <Button Content="å¥—ç”¨èªªæ˜Žè‡³ç©ºç™½æ¬„ä½"
                                Command="{Binding PrepareApplyDescriptionCommand}"
                                IsEnabled="{Binding !IsUpdating}"
                                ToolTip.Tip="å°‡é¸ä¸­è³‡æ–™çš„èªªæ˜Žå¥—ç”¨åˆ°å…¶ä»–åŒåä½†èªªæ˜Žç‚ºç©ºçš„æ¬„ä½"/>
                        <ProgressBar IsIndeterminate="True" Width="80" IsVisible="{Binding IsUpdating}"/>
                    </StackPanel>
                </Border>
            </Grid>

            <!-- ç¢ºèªå°è©±æ¡†è¦†è“‹å±¤ -->
            <Border IsVisible="{Binding ShowApplyDescriptionConfirm}"
                    Background="#80000000"
                    HorizontalAlignment="Stretch" VerticalAlignment="Stretch">
                <Border Background="{DynamicResource SystemControlBackgroundAltHighBrush}"
                        CornerRadius="8" Padding="20"
                        HorizontalAlignment="Center" VerticalAlignment="Center"
                        MinWidth="400" MaxWidth="600">
                    <StackPanel Spacing="15">
                        <TextBlock Text="ç¢ºèªå¥—ç”¨èªªæ˜Ž" FontSize="18" FontWeight="Bold"/>
                        <TextBlock Text="{Binding ApplyDescriptionPreview}" TextWrapping="Wrap"/>
                        <StackPanel Orientation="Horizontal" Spacing="10" HorizontalAlignment="Right">
                            <Button Content="å–æ¶ˆ" Command="{Binding CancelApplyDescriptionCommand}" MinWidth="80"/>
                            <Button Content="ç¢ºèªå¥—ç”¨" Command="{Binding ConfirmApplyDescriptionCommand}" MinWidth="80"
                                    Classes="accent"/>
                        </StackPanel>
                    </StackPanel>
                </Border>
            </Border>

            <!-- åž‹æ…‹ä¸€è‡´æ€§åˆ†æžçµæžœï¼ˆåˆ†æžå¾Œé¡¯ç¤ºï¼‰ -->
            <Grid ColumnDefinitions="*,10,1.2*" IsVisible="{Binding ShowTypeAnalysis}">
                <!-- å·¦å´ï¼šæ¬„ä½ç¾¤çµ„æ¸…å–® -->
                <Border Grid.Column="0" BorderBrush="{DynamicResource SystemControlForegroundBaseMediumBrush}"
                        BorderThickness="1" CornerRadius="4">
                    <Grid RowDefinitions="Auto,*">
                        <Border Grid.Row="0" Background="{DynamicResource SystemControlBackgroundChromeMediumBrush}"
                                Padding="10,6" CornerRadius="4,4,0,0">
                            <TextBlock Text="æ¬„ä½åž‹æ…‹ä¸€è‡´æ€§åˆ†æž" FontWeight="SemiBold"/>
                        </Border>
                        <DataGrid Grid.Row="1"
                                  ItemsSource="{Binding ColumnGroups}"
                                  SelectedItem="{Binding SelectedGroup}"
                                  AutoGenerateColumns="False"
                                  IsReadOnly="True"
                                  GridLinesVisibility="Horizontal"
                                  CanUserResizeColumns="True"
                                  CanUserSortColumns="True">
                            <DataGrid.Columns>
                                <DataGridTextColumn Header="æ¬„ä½åç¨±" Binding="{Binding ColumnName}" Width="120"/>
                                <DataGridTextColumn Header="è³‡æ–™è¡¨æ•¸" Binding="{Binding TableCount}" Width="70"/>
                                <DataGridTextColumn Header="ä¸»è¦åž‹æ…‹" Binding="{Binding PrimaryType}" Width="100"/>
                                <DataGridTextColumn Header="ä¸ä¸€è‡´æ•¸" Binding="{Binding InconsistentCount}" Width="70"/>
                                <DataGridTemplateColumn Header="ä¸€è‡´æ€§" Width="80">
                                    <DataGridTemplateColumn.CellTemplate>
                                        <DataTemplate x:DataType="vm:ColumnTypeGroupViewModel">
                                            <Border CornerRadius="3" Padding="6,2" Margin="2"
                                                    HorizontalAlignment="Center"
                                                    Background="{Binding Level, Converter={StaticResource LevelToColorConverter}}">
                                                <TextBlock Text="{Binding LevelText}"
                                                           Foreground="{Binding Level, Converter={StaticResource LevelToForegroundConverter}}"
                                                           FontSize="11"/>
                                            </Border>
                                        </DataTemplate>
                                    </DataGridTemplateColumn.CellTemplate>
                                </DataGridTemplateColumn>
                            </DataGrid.Columns>
                        </DataGrid>
                    </Grid>
                </Border>

                <GridSplitter Grid.Column="1" Width="6" Background="Transparent"
                              ResizeDirection="Columns" HorizontalAlignment="Center"/>

                <!-- å³å´ï¼šé¸ä¸­ç¾¤çµ„çš„è©³ç´°è³‡è¨Š -->
                <Border Grid.Column="2" BorderBrush="{DynamicResource SystemControlForegroundBaseMediumBrush}"
                        BorderThickness="1" CornerRadius="4">
                    <Grid RowDefinitions="Auto,Auto,*,Auto">
                        <!-- æ¨™é¡Œ -->
                        <Border Grid.Row="0" Background="{DynamicResource SystemControlBackgroundChromeMediumBrush}"
                                Padding="10,6" CornerRadius="4,4,0,0">
                            <TextBlock Text="åž‹æ…‹è©³ç´°è³‡è¨Š" FontWeight="SemiBold"/>
                        </Border>

                        <!-- èªªæ˜Žå€åŸŸ -->
                        <Border Grid.Row="1" Padding="10,8"
                                Background="{DynamicResource SystemControlBackgroundListLowBrush}"
                                IsVisible="{Binding SelectedGroup, Converter={x:Static ObjectConverters.IsNotNull}}">
                            <Grid RowDefinitions="Auto,Auto,Auto">
                                <Grid Grid.Row="0" ColumnDefinitions="*,Auto">
                                    <StackPanel Grid.Column="0" Orientation="Horizontal" Spacing="10">
                                        <TextBlock Text="æ¬„ä½åç¨±ï¼š" FontWeight="SemiBold" VerticalAlignment="Center"/>
                                        <TextBlock Text="{Binding SelectedGroup.ColumnName}" FontSize="14" FontWeight="Bold" VerticalAlignment="Center"/>
                                    </StackPanel>
                                    <StackPanel Grid.Column="1" Orientation="Horizontal" Spacing="8">
                                        <TextBlock Text="ç¯©é¸ï¼š" VerticalAlignment="Center"/>
                                        <ComboBox ItemsSource="{Binding FilterOptions}"
                                                  SelectedItem="{Binding DetailFilter}"
                                                  MinWidth="100"/>
                                    </StackPanel>
                                </Grid>
                                <StackPanel Grid.Row="1" Orientation="Horizontal" Spacing="20" Margin="0,5,0,0">
                                    <StackPanel Orientation="Horizontal" Spacing="5">
                                        <TextBlock Text="ä¸»è¦åž‹æ…‹ï¼š" VerticalAlignment="Center"/>
                                        <Border Background="#4CAF50" CornerRadius="3" Padding="6,2">
                                            <TextBlock Text="{Binding SelectedGroup.PrimaryType}" Foreground="White" FontWeight="SemiBold"/>
                                        </Border>
                                    </StackPanel>
                                    <StackPanel Orientation="Horizontal" Spacing="5">
                                        <TextBlock Text="è³‡æ–™è¡¨ç¸½æ•¸ï¼š" VerticalAlignment="Center"/>
                                        <TextBlock Text="{Binding SelectedGroup.TableCount}" FontWeight="SemiBold" VerticalAlignment="Center"/>
                                    </StackPanel>
                                    <StackPanel Orientation="Horizontal" Spacing="5">
                                        <TextBlock Text="ä¸ä¸€è‡´æ•¸é‡ï¼š" VerticalAlignment="Center"/>
                                        <TextBlock Text="{Binding SelectedGroup.InconsistentCount}"
                                                   FontWeight="SemiBold"
                                                   Foreground="#F44336" VerticalAlignment="Center"/>
                                    </StackPanel>
                                </StackPanel>
                                <TextBlock Grid.Row="2" Margin="0,5,0,0" FontSize="11"
                                           Foreground="{DynamicResource SystemControlForegroundBaseMediumBrush}">
                                    <Run Text="åž‹æ…‹åˆ†å¸ƒï¼š"/>
                                    <Run Text="{Binding SelectedGroup.TypeSummary}"/>
                                </TextBlock>
                            </Grid>
                        </Border>

                        <!-- è©³ç´°è³‡æ–™è¡¨æ ¼ -->
                        <DataGrid Grid.Row="2"
                                  ItemsSource="{Binding FilteredColumns}"
                                  SelectedItem="{Binding SelectedColumnType}"
                                  AutoGenerateColumns="False"
                                  IsReadOnly="True"
                                  GridLinesVisibility="All"
                                  CanUserResizeColumns="True">
                            <DataGrid.Columns>
                                <!-- ç‹€æ…‹æ¬„ä½ -->
                                <DataGridTemplateColumn Header="ç‹€æ…‹" Width="80">
                                    <DataGridTemplateColumn.CellTemplate>
                                        <DataTemplate x:DataType="domain:ColumnTypeInfo">
                                            <Border CornerRadius="3" Padding="4,2" Margin="2"
                                                    HorizontalAlignment="Center">
                                                <Border.Background>
                                                    <Binding Path="IsConsistent">
                                                        <Binding.Converter>
                                                            <converters:ConsistentToColorConverter/>
                                                        </Binding.Converter>
                                                    </Binding>
                                                </Border.Background>
                                                <TextBlock Text="{Binding StatusText}" FontSize="11">
                                                    <TextBlock.Foreground>
                                                        <Binding Path="IsConsistent">
                                                            <Binding.Converter>
                                                                <converters:ConsistentToForegroundConverter/>
                                                            </Binding.Converter>
                                                        </Binding>
                                                    </TextBlock.Foreground>
                                                </TextBlock>
                                            </Border>
                                        </DataTemplate>
                                    </DataGridTemplateColumn.CellTemplate>
                                </DataGridTemplateColumn>
                                <DataGridTextColumn Header="Schema" Binding="{Binding SchemaName}" Width="80"/>
                                <DataGridTextColumn Header="è³‡æ–™è¡¨" Binding="{Binding TableName}" Width="150"/>
                                <DataGridTextColumn Header="åž‹æ…‹" Binding="{Binding DataType}" Width="120"/>
                                <DataGridCheckBoxColumn Header="å¯ Null" Binding="{Binding IsNullable}" Width="60"/>
                                <DataGridTextColumn Header="ç´„æŸæ•¸" Binding="{Binding Constraints.Count}" Width="60"/>
                                <DataGridTextColumn Header="å¯è®Šæ›´" Binding="{Binding IsLengthChangeable, Converter={StaticResource BoolToYesNoConverter}}" Width="60"/>
                            </DataGrid.Columns>
                        </DataGrid>

                        <!-- æ›´æ–°é•·åº¦é¢æ¿ -->
                        <Border Grid.Row="3" Background="{DynamicResource SystemControlBackgroundChromeMediumBrush}"
                                Padding="10,8" CornerRadius="0,0,4,4"
                                IsVisible="{Binding SelectedGroup, Converter={x:Static ObjectConverters.IsNotNull}}">
                            <Grid RowDefinitions="Auto,Auto">
                                <!-- æ‰¹æ¬¡æ›´æ–°åˆ— -->
                                <StackPanel Grid.Row="0" Orientation="Horizontal" Spacing="12">
                                    <TextBlock Text="æ‰¹æ¬¡æ›´æ–°ï¼š" VerticalAlignment="Center" FontWeight="SemiBold"/>
                                    <TextBlock Text="æ–°é•·åº¦ï¼š" VerticalAlignment="Center"/>
                                    <NumericUpDown Value="{Binding BatchNewLength}"
                                                   Minimum="-1" Maximum="8000"
                                                   Width="120" FormatString="0"
                                                   ToolTip.Tip="è¼¸å…¥æ–°çš„é•·åº¦ï¼ˆ-1 è¡¨ç¤º MAXï¼‰"/>
                                    <Button Content="æ›´æ–°æ‰€æœ‰ä¸ä¸€è‡´é …ç›®"
                                            Command="{Binding BatchUpdateLengthCommand}"
                                            IsEnabled="{Binding !IsUpdating}"
                                            ToolTip.Tip="å°‡æ‰€æœ‰ä¸ä¸€è‡´ä¸”å¯è®Šæ›´é•·åº¦çš„æ¬„ä½æ›´æ–°ç‚ºæŒ‡å®šé•·åº¦"/>
                                    <ProgressBar IsIndeterminate="True" Width="80"
                                                 IsVisible="{Binding IsUpdating}"/>
                                    <TextBlock Text="{Binding BatchUpdateProgress}"
                                               VerticalAlignment="Center"
                                               Foreground="{DynamicResource SystemControlForegroundBaseMediumBrush}"/>
                                </StackPanel>

                                <!-- å–®ç­†æ›´æ–°åˆ— -->
                                <Grid Grid.Row="1" ColumnDefinitions="Auto,Auto,Auto,*,Auto" Margin="0,8,0,0"
                                      IsVisible="{Binding SelectedColumnType, Converter={x:Static ObjectConverters.IsNotNull}}">
                                    <StackPanel Grid.Column="0" Orientation="Horizontal" Spacing="8">
                                        <TextBlock Text="é¸ä¸­ï¼š" VerticalAlignment="Center"/>
                                        <TextBlock Text="{Binding SelectedColumnType.FullTableName}"
                                                   FontWeight="SemiBold" VerticalAlignment="Center"/>
                                        <TextBlock Text="{Binding SelectedColumnType.DataType, StringFormat='({0})'}"
                                                   VerticalAlignment="Center"
                                                   Foreground="{DynamicResource SystemControlForegroundBaseMediumBrush}"/>
                                    </StackPanel>

                                    <StackPanel Grid.Column="1" Orientation="Horizontal" Spacing="8" Margin="20,0,0,0"
                                                IsVisible="{Binding SelectedColumnType.IsLengthChangeable}">
                                        <TextBlock Text="æ–°é•·åº¦ï¼š" VerticalAlignment="Center"/>
                                        <NumericUpDown Value="{Binding NewLength}"
                                                       Minimum="-1" Maximum="8000"
                                                       Width="120" FormatString="0"
                                                       ToolTip.Tip="è¼¸å…¥æ–°çš„é•·åº¦ï¼ˆ-1 è¡¨ç¤º MAXï¼‰"/>
                                    </StackPanel>

                                    <StackPanel Grid.Column="2" Orientation="Horizontal" Spacing="8" Margin="10,0,0,0"
                                                IsVisible="{Binding SelectedColumnType.IsLengthChangeable}">
                                        <Button Content="æ›´æ–°æ­¤æ¬„ä½"
                                                Command="{Binding UpdateColumnLengthCommand}"
                                                CommandParameter="{Binding SelectedColumnType}"
                                                IsEnabled="{Binding !IsUpdating}"/>
                                    </StackPanel>

                                    <Button Grid.Column="4" Content="è¼‰å…¥ç´„æŸ"
                                            Command="{Binding RefreshConstraintsCommand}"
                                            CommandParameter="{Binding SelectedColumnType}"
                                            HorizontalAlignment="Right"/>
                                </Grid>
                            </Grid>
                        </Border>
                    </Grid>
                </Border>
            </Grid>
        </Grid>

        <!-- ç‹€æ…‹åˆ— -->
        <Border Grid.Row="2" Background="{DynamicResource SystemControlBackgroundChromeMediumBrush}" Padding="10,5">
            <SelectableTextBlock Text="{Binding StatusMessage}" VerticalAlignment="Center"/>
        </Border>
    </Grid>
</UserControl>
