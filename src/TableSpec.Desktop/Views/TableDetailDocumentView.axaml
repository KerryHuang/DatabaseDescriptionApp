<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:vm="using:TableSpec.Desktop.ViewModels"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             mc:Ignorable="d" d:DesignWidth="800" d:DesignHeight="500"
             x:Class="TableSpec.Desktop.Views.TableDetailDocumentView"
             x:DataType="vm:TableDetailDocumentViewModel">

    <Design.DataContext>
        <vm:TableDetailDocumentViewModel/>
    </Design.DataContext>

    <DockPanel>
        <!-- 表格標題 -->
        <Border DockPanel.Dock="Top" Margin="0,0,0,10">
            <StackPanel>
                <TextBlock Text="{Binding CurrentTable.Name, FallbackValue='請選擇物件'}"
                           FontSize="18" FontWeight="Bold"/>
                <TextBlock Text="{Binding CurrentTable.Description}"
                           Foreground="Gray" Margin="0,5,0,0"/>
            </StackPanel>
        </Border>

        <!-- 分頁 -->
        <TabControl SelectedIndex="{Binding SelectedTabIndex}">
            <!-- 欄位頁籤 (Table/View) -->
            <TabItem Header="欄位"
                     IsVisible="{Binding CurrentTable.Type,
                                 Converter={x:Static StringConverters.IsNotNullOrEmpty},
                                 FallbackValue=True}">
                <DockPanel>
                    <!-- 工具列 -->
                    <Border DockPanel.Dock="Top" Padding="5" Background="{DynamicResource SystemControlBackgroundChromeMediumLowBrush}">
                        <Grid ColumnDefinitions="*,Auto">
                            <StackPanel Grid.Column="0" Orientation="Horizontal" Spacing="10">
                                <TextBlock Text="{Binding StatusMessage}"
                                           VerticalAlignment="Center"
                                           Foreground="{DynamicResource SystemControlForegroundBaseMediumBrush}"/>
                            </StackPanel>
                            <StackPanel Grid.Column="1" Orientation="Horizontal" Spacing="5">
                                <Button Content="儲存變更"
                                        Command="{Binding SaveColumnDescriptionsCommand}"
                                        IsVisible="{Binding HasUnsavedChanges}"/>
                                <Button Content="取消"
                                        Command="{Binding CancelChangesCommand}"
                                        IsVisible="{Binding HasUnsavedChanges}"/>
                            </StackPanel>
                        </Grid>
                    </Border>
                    <!-- 欄位表格 -->
                    <DataGrid x:Name="ColumnsGrid"
                              ItemsSource="{Binding Columns}"
                              AutoGenerateColumns="False"
                              IsReadOnly="False"
                              GridLinesVisibility="All"
                              CanUserResizeColumns="True"
                              CellEditEnded="OnColumnCellEditEnded">
                        <DataGrid.Columns>
                            <DataGridTextColumn Header="欄位名稱" Binding="{Binding ColumnName}" Width="150" IsReadOnly="True"/>
                            <DataGridTextColumn Header="資料型別" Binding="{Binding DataType}" Width="100" IsReadOnly="True"/>
                            <DataGridTextColumn Header="長度" Binding="{Binding Length}" Width="60" IsReadOnly="True"/>
                            <DataGridCheckBoxColumn Header="PK" Binding="{Binding IsPrimaryKey}" Width="50" IsReadOnly="True"/>
                            <DataGridCheckBoxColumn Header="Null" Binding="{Binding IsNullable}" Width="50" IsReadOnly="True"/>
                            <DataGridTextColumn Header="預設值" Binding="{Binding DefaultValue}" Width="100" IsReadOnly="True"/>
                            <DataGridTextColumn Header="說明 (可編輯)" Binding="{Binding Description}" Width="*" IsReadOnly="False"/>
                        </DataGrid.Columns>
                    </DataGrid>
                </DockPanel>
            </TabItem>
            <!-- 索引頁籤 (Table only) -->
            <TabItem Header="索引">
                <DataGrid ItemsSource="{Binding Indexes}"
                          AutoGenerateColumns="False"
                          IsReadOnly="True"
                          GridLinesVisibility="All">
                    <DataGrid.Columns>
                        <DataGridTextColumn Header="索引名稱" Binding="{Binding Name}" Width="200"/>
                        <DataGridTextColumn Header="類型" Binding="{Binding Type}" Width="120"/>
                        <DataGridCheckBoxColumn Header="唯一" Binding="{Binding IsUnique}" Width="60"/>
                        <DataGridCheckBoxColumn Header="主鍵" Binding="{Binding IsPrimaryKey}" Width="60"/>
                        <DataGridTextColumn Header="欄位" Binding="{Binding Columns}" Width="*"/>
                    </DataGrid.Columns>
                </DataGrid>
            </TabItem>
            <!-- 關聯頁籤 (Table only) -->
            <TabItem Header="關聯">
                <DataGrid ItemsSource="{Binding Relations}"
                          AutoGenerateColumns="False"
                          IsReadOnly="True"
                          GridLinesVisibility="All">
                    <DataGrid.Columns>
                        <DataGridTextColumn Header="約束名稱" Binding="{Binding ConstraintName}" Width="200"/>
                        <DataGridTextColumn Header="來源表.欄位" Binding="{Binding FromTable}" Width="150"/>
                        <DataGridTextColumn Header="來源欄位" Binding="{Binding FromColumn}" Width="100"/>
                        <DataGridTextColumn Header="目標表" Binding="{Binding ToTable}" Width="150"/>
                        <DataGridTextColumn Header="目標欄位" Binding="{Binding ToColumn}" Width="100"/>
                    </DataGrid.Columns>
                </DataGrid>
            </TabItem>
            <!-- 參數頁籤 (SP/Function) -->
            <TabItem Header="參數">
                <DataGrid ItemsSource="{Binding Parameters}"
                          AutoGenerateColumns="False"
                          IsReadOnly="True"
                          GridLinesVisibility="All">
                    <DataGrid.Columns>
                        <DataGridTextColumn Header="順序" Binding="{Binding Ordinal}" Width="60"/>
                        <DataGridTextColumn Header="參數名稱" Binding="{Binding Name}" Width="150"/>
                        <DataGridTextColumn Header="資料型別" Binding="{Binding DataType}" Width="120"/>
                        <DataGridTextColumn Header="長度" Binding="{Binding Length}" Width="80"/>
                        <DataGridCheckBoxColumn Header="輸出" Binding="{Binding IsOutput}" Width="60"/>
                        <DataGridTextColumn Header="預設值" Binding="{Binding DefaultValue}" Width="*"/>
                    </DataGrid.Columns>
                </DataGrid>
            </TabItem>
            <!-- 定義頁籤 (SP/Function) -->
            <TabItem Header="定義">
                <ScrollViewer>
                    <TextBox Text="{Binding Definition}"
                             IsReadOnly="True"
                             AcceptsReturn="True"
                             FontFamily="Consolas, Menlo, monospace"
                             FontSize="12"
                             TextWrapping="Wrap"/>
                </ScrollViewer>
            </TabItem>
        </TabControl>
    </DockPanel>
</UserControl>
