<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:vm="using:TableSpec.Desktop.ViewModels"
             xmlns:domain="using:TableSpec.Domain.Entities"
             xmlns:converters="using:TableSpec.Desktop.Converters"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             mc:Ignorable="d" d:DesignWidth="1200" d:DesignHeight="700"
             x:Class="TableSpec.Desktop.Views.ColumnUsageDocumentView"
             x:DataType="vm:ColumnUsageDocumentViewModel">

    <UserControl.Resources>
        <converters:BoolToConsistencyColorConverter x:Key="BoolToColorConverter"/>
        <converters:BoolToConsistencyForegroundConverter x:Key="BoolToForegroundConverter"/>
        <converters:BoolToDifferenceTextConverter x:Key="BoolToDifferenceConverter"/>
        <converters:DifferenceToColorConverter x:Key="DifferenceToColorConverter"/>
        <converters:BoolToNullableTextConverter x:Key="BoolToNullableConverter"/>
    </UserControl.Resources>

    <Design.DataContext>
        <vm:ColumnUsageDocumentViewModel/>
    </Design.DataContext>

    <Grid RowDefinitions="Auto,*,Auto">
        <!-- å·¥å…·åˆ— -->
        <Border Grid.Row="0" Background="{DynamicResource SystemControlBackgroundChromeMediumBrush}" Padding="10,8">
            <StackPanel Orientation="Horizontal" Spacing="15">
                <!-- æœå°‹ -->
                <StackPanel Orientation="Horizontal" Spacing="8"
                            ToolTip.Tip="è¼¸å…¥æ¬„ä½åç¨±é—œéµå­—é€²è¡Œæœå°‹ï¼Œæ”¯æ´éƒ¨åˆ†æ¯”å°ã€‚">
                    <TextBlock Text="æœå°‹æ¬„ä½ï¼š" VerticalAlignment="Center"/>
                    <TextBox Text="{Binding SearchText}"
                             Width="200"
                             Watermark="è¼¸å…¥æ¬„ä½åç¨±..."/>
                </StackPanel>

                <!-- æœ€å°å‡ºç¾æ¬¡æ•¸ -->
                <StackPanel Orientation="Horizontal" Spacing="8"
                            ToolTip.Tip="ç¯©é¸æ¬„ä½åç¨±åœ¨è³‡æ–™åº«ä¸­å‡ºç¾çš„æœ€å°‘æ¬¡æ•¸ã€‚&#x0a;ä¾‹å¦‚è¨­ç‚º 2ï¼Œè¡¨ç¤ºåªé¡¯ç¤ºå‡ºç¾ 2 æ¬¡ä»¥ä¸Šçš„åŒåæ¬„ä½ã€‚&#x0a;å‡ºç¾ 1 æ¬¡çš„æ¬„ä½ç„¡æ¯”å°å°è±¡ï¼Œé€šå¸¸å¯å¿½ç•¥ã€‚">
                    <TextBlock Text="æœ€å°æ¬¡æ•¸ï¼š" VerticalAlignment="Center"/>
                    <ComboBox MinWidth="80"
                              ItemsSource="{Binding MinUsageCountOptions}"
                              SelectedItem="{Binding MinUsageCount}"/>
                    <TextBlock Text="â„¹ï¸" FontSize="12" VerticalAlignment="Center" Opacity="0.6"
                               ToolTip.Tip="ç¯©é¸æ¬„ä½åç¨±åœ¨è³‡æ–™åº«ä¸­å‡ºç¾çš„æœ€å°‘æ¬¡æ•¸ã€‚&#x0a;ä¾‹å¦‚è¨­ç‚º 2ï¼Œè¡¨ç¤ºåªé¡¯ç¤ºå‡ºç¾ 2 æ¬¡ä»¥ä¸Šçš„åŒåæ¬„ä½ã€‚&#x0a;å‡ºç¾ 1 æ¬¡çš„æ¬„ä½ç„¡æ¯”å°å°è±¡ï¼Œé€šå¸¸å¯å¿½ç•¥ã€‚"/>
                </StackPanel>

                <!-- åªé¡¯ç¤ºä¸ä¸€è‡´ -->
                <CheckBox Content="åªé¡¯ç¤ºä¸ä¸€è‡´" IsChecked="{Binding ShowOnlyInconsistent}"
                          ToolTip.Tip="å‹¾é¸å¾Œåªé¡¯ç¤ºåž‹åˆ¥ã€é•·åº¦æˆ–å¯ç©ºæ€§ä¸ä¸€è‡´çš„æ¬„ä½ã€‚&#x0a;ç”¨æ–¼å¿«é€Ÿæ‰¾å‡ºéœ€è¦æª¢è¦–çš„å•é¡Œæ¬„ä½ã€‚"/>

                <!-- æ“ä½œæŒ‰éˆ• -->
                <Button Command="{Binding LoadCommand}"
                        IsEnabled="{Binding !IsLoading}">
                    <StackPanel Orientation="Horizontal" Spacing="5">
                        <TextBlock Text="ðŸ”„" FontSize="14"/>
                        <TextBlock Text="è¼‰å…¥"/>
                    </StackPanel>
                </Button>

                <Button Command="{Binding ExportCommand}"
                        IsEnabled="{Binding !IsLoading}">
                    <StackPanel Orientation="Horizontal" Spacing="5">
                        <TextBlock Text="ðŸ“¥" FontSize="14"/>
                        <TextBlock Text="åŒ¯å‡º Excel"/>
                    </StackPanel>
                </Button>

                <Button Command="{Binding ClearFilterCommand}">
                    <StackPanel Orientation="Horizontal" Spacing="5">
                        <TextBlock Text="ðŸ—‘ï¸" FontSize="14"/>
                        <TextBlock Text="æ¸…é™¤ç¯©é¸"/>
                    </StackPanel>
                </Button>

                <!-- è¼‰å…¥ä¸­æŒ‡ç¤ºå™¨ -->
                <ProgressBar IsIndeterminate="True" Width="80"
                             IsVisible="{Binding IsLoading}"/>
            </StackPanel>
        </Border>

        <!-- ä¸»è¦å…§å®¹ï¼šåˆ†çµ„æª¢è¦– -->
        <Grid Grid.Row="1" ColumnDefinitions="*,*" Margin="10,5">
            <!-- å·¦å´ï¼šæ¬„ä½æ¸…å–® -->
            <Border Grid.Column="0" BorderBrush="{DynamicResource SystemControlForegroundBaseMediumBrush}"
                    BorderThickness="1" Margin="0,0,5,0">
                <Grid RowDefinitions="Auto,*">
                    <Border Grid.Row="0" Background="{DynamicResource SystemControlBackgroundChromeMediumBrush}" Padding="10,5">
                        <TextBlock Text="æ¬„ä½çµ±è¨ˆæ¸…å–®" FontWeight="Bold"/>
                    </Border>
                    <ListBox Grid.Row="1"
                             ItemsSource="{Binding Statistics}"
                             SelectedItem="{Binding SelectedStatistics}">
                        <ListBox.ItemTemplate>
                            <DataTemplate x:DataType="domain:ColumnUsageStatistics">
                                <Border Padding="8,6" BorderThickness="0,0,0,1"
                                        BorderBrush="{DynamicResource SystemControlForegroundBaseLowBrush}">
                                    <Grid ColumnDefinitions="*,Auto">
                                        <StackPanel Grid.Column="0" Spacing="3">
                                            <StackPanel Orientation="Horizontal" Spacing="8">
                                                <TextBlock Text="{Binding ColumnName}" FontWeight="SemiBold" FontSize="14"/>
                                                <TextBlock Text="{Binding UsageCount, StringFormat='({0} æ¬¡)'}"
                                                           Foreground="{DynamicResource SystemControlForegroundBaseMediumBrush}"/>
                                            </StackPanel>
                                            <StackPanel Orientation="Horizontal" Spacing="5">
                                                <TextBlock Text="{Binding PrimaryDataType}"
                                                           Foreground="{DynamicResource SystemControlForegroundBaseMediumBrush}"
                                                           FontSize="12"/>
                                            </StackPanel>
                                        </StackPanel>
                                        <StackPanel Grid.Column="1" Orientation="Horizontal" Spacing="5" VerticalAlignment="Center">
                                            <!-- ä¸€è‡´æ€§æ¨™è¨˜ -->
                                            <Border Background="{Binding IsTypeConsistent, Converter={StaticResource BoolToColorConverter}}"
                                                    CornerRadius="3" Padding="4,2"
                                                    ToolTip.Tip="åž‹åˆ¥ä¸€è‡´æ€§">
                                                <TextBlock Text="åž‹åˆ¥" FontSize="10"
                                                           Foreground="{Binding IsTypeConsistent, Converter={StaticResource BoolToForegroundConverter}}"/>
                                            </Border>
                                            <Border Background="{Binding IsLengthConsistent, Converter={StaticResource BoolToColorConverter}}"
                                                    CornerRadius="3" Padding="4,2"
                                                    ToolTip.Tip="é•·åº¦ä¸€è‡´æ€§">
                                                <TextBlock Text="é•·åº¦" FontSize="10"
                                                           Foreground="{Binding IsLengthConsistent, Converter={StaticResource BoolToForegroundConverter}}"/>
                                            </Border>
                                            <Border Background="{Binding IsNullabilityConsistent, Converter={StaticResource BoolToColorConverter}}"
                                                    CornerRadius="3" Padding="4,2"
                                                    ToolTip.Tip="å¯ç©ºä¸€è‡´æ€§">
                                                <TextBlock Text="å¯ç©º" FontSize="10"
                                                           Foreground="{Binding IsNullabilityConsistent, Converter={StaticResource BoolToForegroundConverter}}"/>
                                            </Border>
                                        </StackPanel>
                                    </Grid>
                                </Border>
                            </DataTemplate>
                        </ListBox.ItemTemplate>
                    </ListBox>
                </Grid>
            </Border>

            <!-- å³å´ï¼šè©³ç´°è³‡è¨Š -->
            <Border Grid.Column="1" BorderBrush="{DynamicResource SystemControlForegroundBaseMediumBrush}"
                    BorderThickness="1" Margin="5,0,0,0">
                <Grid RowDefinitions="Auto,Auto,Auto,*">
                    <!-- æ¨™é¡Œåˆ— -->
                    <Border Grid.Row="0" Background="{DynamicResource SystemControlBackgroundChromeMediumBrush}" Padding="10,5">
                        <Grid ColumnDefinitions="*,Auto">
                            <TextBlock Grid.Column="0" FontWeight="Bold">
                                <TextBlock.Text>
                                    <MultiBinding StringFormat="ä½¿ç”¨æ˜Žç´° - {0}">
                                        <Binding Path="SelectedStatistics.ColumnName" FallbackValue="è«‹é¸æ“‡æ¬„ä½"/>
                                    </MultiBinding>
                                </TextBlock.Text>
                            </TextBlock>
                            <!-- åªé¡¯ç¤ºå·®ç•°ç¯©é¸ -->
                            <CheckBox Grid.Column="1" Content="åªé¡¯ç¤ºå·®ç•°" IsChecked="{Binding ShowOnlyDifferent}"
                                      IsVisible="{Binding SelectedStatistics, Converter={x:Static ObjectConverters.IsNotNull}}"
                                      ToolTip.Tip="å‹¾é¸å¾Œåªé¡¯ç¤ºèˆ‡ä¸»è¦åž‹æ…‹ä¸åŒçš„æ¬„ä½ä½¿ç”¨è¨˜éŒ„ã€‚"/>
                        </Grid>
                    </Border>

                    <!-- ä¸»è¦åž‹æ…‹èªªæ˜Žï¼ˆæ¯”å°åŸºæº–ï¼‰ -->
                    <Border Grid.Row="1" Background="{DynamicResource SystemControlBackgroundAltMediumLowBrush}"
                            Padding="10,8" IsVisible="{Binding SelectedStatistics, Converter={x:Static ObjectConverters.IsNotNull}}">
                        <StackPanel Spacing="5">
                            <TextBlock Text="ðŸ“Œ æ¯”å°åŸºæº–ï¼ˆä¸»è¦åž‹æ…‹ï¼‰" FontWeight="SemiBold" Foreground="{DynamicResource SystemControlForegroundBaseHighBrush}"/>
                            <WrapPanel Orientation="Horizontal">
                                <TextBlock Text="åž‹åˆ¥ï¼š" Foreground="{DynamicResource SystemControlForegroundBaseMediumBrush}"/>
                                <TextBlock Text="{Binding SelectedStatistics.PrimaryDataType}" FontWeight="SemiBold" Margin="0,0,15,0"/>
                                <TextBlock Text="å¯ç©ºï¼š" Foreground="{DynamicResource SystemControlForegroundBaseMediumBrush}"/>
                                <TextBlock Text="{Binding SelectedStatistics.PrimaryIsNullable, Converter={StaticResource BoolToNullableConverter}}" FontWeight="SemiBold"/>
                            </WrapPanel>
                        </StackPanel>
                    </Border>

                    <!-- èªªæ˜Žå€å¡Š -->
                    <Border Grid.Row="2" Background="{DynamicResource SystemControlBackgroundListLowBrush}"
                            Padding="10,6" BorderThickness="0,1,0,1"
                            BorderBrush="{DynamicResource SystemControlForegroundBaseLowBrush}">
                        <StackPanel Orientation="Horizontal" Spacing="8">
                            <TextBlock Text="â„¹ï¸" FontSize="12"/>
                            <TextBlock Text="å·®ç•°èªªæ˜Žï¼šç³»çµ±ä»¥æœ€å¤šä½¿ç”¨çš„åž‹æ…‹ä½œç‚ºã€Œä¸»è¦åž‹æ…‹ã€ï¼Œèˆ‡ä¸»è¦åž‹æ…‹ä¸åŒçš„æ¬„ä½æœƒæ¨™è¨˜ç‚ºã€Œå·®ç•°ã€ã€‚"
                                       FontSize="11" Foreground="{DynamicResource SystemControlForegroundBaseMediumBrush}"
                                       TextWrapping="Wrap"/>
                        </StackPanel>
                    </Border>

                    <!-- è³‡æ–™è¡¨æ ¼ -->
                    <DataGrid Grid.Row="3"
                              ItemsSource="{Binding FilteredUsages}"
                              AutoGenerateColumns="False"
                              IsReadOnly="True"
                              GridLinesVisibility="All"
                              CanUserResizeColumns="True"
                              CanUserSortColumns="True">
                        <DataGrid.Columns>
                            <DataGridTextColumn Header="Schema" Binding="{Binding SchemaName}" Width="80"/>
                            <DataGridTextColumn Header="ç‰©ä»¶åç¨±" Binding="{Binding ObjectName}" Width="180"/>
                            <DataGridTextColumn Header="é¡žåž‹" Binding="{Binding ObjectType}" Width="70"/>
                            <DataGridTextColumn Header="è³‡æ–™åž‹åˆ¥" Binding="{Binding DataType}" Width="130"/>
                            <DataGridTextColumn Header="å¯ç©º" Width="80"
                                                Binding="{Binding IsNullable, Converter={StaticResource BoolToNullableConverter}}"/>
                            <DataGridTemplateColumn Header="å·®ç•°" Width="60">
                                <DataGridTemplateColumn.CellTemplate>
                                    <DataTemplate x:DataType="domain:ColumnUsageDetail">
                                        <TextBlock Text="{Binding HasDifference, Converter={StaticResource BoolToDifferenceConverter}}"
                                                   Foreground="{Binding HasDifference, Converter={StaticResource DifferenceToColorConverter}}"
                                                   HorizontalAlignment="Center"
                                                   FontWeight="Bold"/>
                                    </DataTemplate>
                                </DataGridTemplateColumn.CellTemplate>
                            </DataGridTemplateColumn>
                        </DataGrid.Columns>
                    </DataGrid>
                </Grid>
            </Border>
        </Grid>

        <!-- ç‹€æ…‹åˆ— -->
        <Border Grid.Row="2" Background="{DynamicResource SystemControlBackgroundChromeMediumBrush}" Padding="10,5">
            <Grid ColumnDefinitions="*,Auto">
                <TextBlock Grid.Column="0" Text="{Binding StatusMessage}" VerticalAlignment="Center"/>
                <StackPanel Grid.Column="1" Orientation="Horizontal" Spacing="15">
                    <TextBlock VerticalAlignment="Center">
                        <TextBlock.Text>
                            <MultiBinding StringFormat="å…± {0} å€‹æ¬„ä½">
                                <Binding Path="TotalColumnCount"/>
                            </MultiBinding>
                        </TextBlock.Text>
                    </TextBlock>
                    <TextBlock VerticalAlignment="Center" Foreground="OrangeRed">
                        <TextBlock.Text>
                            <MultiBinding StringFormat="ä¸ä¸€è‡´ {0} å€‹">
                                <Binding Path="InconsistentCount"/>
                            </MultiBinding>
                        </TextBlock.Text>
                    </TextBlock>
                </StackPanel>
            </Grid>
        </Border>
    </Grid>
</UserControl>
