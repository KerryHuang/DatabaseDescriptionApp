<Window xmlns="https://github.com/avaloniaui"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:vm="using:TableSpec.Desktop.ViewModels"
        xmlns:views="using:TableSpec.Desktop.Views"
        xmlns:domain="using:TableSpec.Domain.Entities"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        mc:Ignorable="d" d:DesignWidth="1200" d:DesignHeight="700"
        x:Class="TableSpec.Desktop.Views.MainWindow"
        x:DataType="vm:MainWindowViewModel"
        Icon="/Assets/TableSpec.png"
        Title="TableSpec - 資料庫規格查詢工具"
        Width="1200" Height="700"
        MinWidth="800" MinHeight="500">

    <Design.DataContext>
        <vm:MainWindowViewModel/>
    </Design.DataContext>

    <DockPanel>
        <!-- 功能表列 + 主題切換 -->
        <Grid DockPanel.Dock="Top" ColumnDefinitions="*,Auto">
            <Menu Grid.Column="0">
                <MenuItem Header="檔案(_F)">
                    <MenuItem Header="連線設定(_C)" Command="{Binding OpenConnectionSettingsCommand}" InputGesture="Ctrl+L">
                        <MenuItem.Icon>
                            <TextBlock Text="" FontSize="14"/>
                        </MenuItem.Icon>
                    </MenuItem>
                    <MenuItem Header="匯出 Excel(_E)" Command="{Binding ExportToExcelCommand}" IsEnabled="{Binding IsConnected}">
                        <MenuItem.Icon>
                            <TextBlock Text="" FontSize="14"/>
                        </MenuItem.Icon>
                    </MenuItem>
                    <Separator/>
                    <MenuItem Header="結束(_X)" Command="{Binding ExitCommand}" InputGesture="Alt+F4">
                        <MenuItem.Icon>
                            <TextBlock Text="" FontSize="14"/>
                        </MenuItem.Icon>
                    </MenuItem>
                </MenuItem>
                <MenuItem Header="檢視(_V)">
                    <MenuItem Header="深色模式(_D)" Command="{Binding ToggleThemeCommand}">
                        <MenuItem.Icon>
                            <CheckBox IsChecked="{Binding IsDarkMode}" BorderThickness="0" IsHitTestVisible="False"/>
                        </MenuItem.Icon>
                    </MenuItem>
                    <Separator/>
                    <MenuItem Header="關閉目前分頁(_C)" Command="{Binding CloseCurrentDocumentCommand}" InputGesture="Ctrl+W"/>
                    <MenuItem Header="關閉所有分頁(_A)" Command="{Binding CloseAllDocumentsCommand}"/>
                </MenuItem>
                <MenuItem Header="工具(_T)">
                    <MenuItem Header="SQL 查詢(_S)" Command="{Binding OpenSqlQueryCommand}" InputGesture="Ctrl+Q" IsEnabled="{Binding IsConnected}">
                        <MenuItem.Icon>
                            <TextBlock Text="" FontSize="14"/>
                        </MenuItem.Icon>
                    </MenuItem>
                    <MenuItem Header="欄位搜尋(_F)" Command="{Binding OpenColumnSearchCommand}" InputGesture="Ctrl+F" IsEnabled="{Binding IsConnected}">
                        <MenuItem.Icon>
                            <TextBlock Text="" FontSize="14"/>
                        </MenuItem.Icon>
                    </MenuItem>
                    <Separator/>
                    <MenuItem Header="備份與還原(_B)" Command="{Binding OpenBackupRestoreCommand}" InputGesture="Ctrl+B" IsEnabled="{Binding IsConnected}">
                        <MenuItem.Icon>
                            <TextBlock Text="" FontSize="14"/>
                        </MenuItem.Icon>
                    </MenuItem>
                    <MenuItem Header="Schema Compare(_M)" Command="{Binding OpenSchemaCompareCommand}" InputGesture="Ctrl+M">
                        <MenuItem.Icon>
                            <TextBlock Text="" FontSize="14"/>
                        </MenuItem.Icon>
                    </MenuItem>
                </MenuItem>
                <MenuItem Header="說明(_H)">
                    <MenuItem Header="關於 TableSpec(_A)" Command="{Binding ShowAboutCommand}">
                        <MenuItem.Icon>
                            <TextBlock Text="" FontSize="14"/>
                        </MenuItem.Icon>
                    </MenuItem>
                </MenuItem>
            </Menu>

            <!-- 右側：主題切換 -->
            <Button Grid.Column="1"
                    Content="{Binding ThemeIcon}"
                    Command="{Binding ToggleThemeCommand}"
                    ToolTip.Tip="切換深色/淺色模式"
                    FontSize="16"
                    Padding="10,4"
                    Margin="5,0"
                    Background="Transparent"
                    BorderThickness="0"/>
        </Grid>

        <!-- 底部狀態列 -->
        <Border DockPanel.Dock="Bottom" Background="{DynamicResource SystemControlBackgroundChromeMediumBrush}" Padding="10,5">
            <Grid ColumnDefinitions="*,Auto">
                <TextBlock Grid.Column="0" Text="{Binding StatusMessage}" VerticalAlignment="Center"/>
                <ProgressBar Grid.Column="1" IsIndeterminate="True" Width="100"
                             IsVisible="{Binding IsExporting}" VerticalAlignment="Center"/>
            </Grid>
        </Border>

        <!-- 主內容區域 -->
        <Grid ColumnDefinitions="280,5,*">
            <!-- 左側：物件樹 -->
            <Border Grid.Column="0" Background="{DynamicResource SystemControlBackgroundAltMediumLowBrush}">
                <DockPanel>
                    <!-- 連線選擇區 -->
                    <Border DockPanel.Dock="Top" Padding="10" Background="{DynamicResource SystemControlBackgroundChromeMediumBrush}">
                        <StackPanel Spacing="8">
                            <ComboBox ItemsSource="{Binding ConnectionProfiles}"
                                      SelectedItem="{Binding SelectedProfile}"
                                      PlaceholderText="請選擇連線..."
                                      HorizontalAlignment="Stretch">
                                <ComboBox.ItemTemplate>
                                    <DataTemplate x:DataType="domain:ConnectionProfile">
                                        <TextBlock Text="{Binding Name}"/>
                                    </DataTemplate>
                                </ComboBox.ItemTemplate>
                            </ComboBox>
                            <Button Content="設定連線"
                                    Command="{Binding OpenConnectionSettingsCommand}"
                                    HorizontalAlignment="Stretch"
                                    HorizontalContentAlignment="Center"/>
                        </StackPanel>
                    </Border>

                    <!-- 搜尋框 -->
                    <Border DockPanel.Dock="Top" Padding="10,10,10,5">
                        <TextBox Watermark="搜尋物件..."
                                 Text="{Binding ObjectTree.SearchText, Mode=TwoWay}"/>
                    </Border>

                    <!-- 物件清單 -->
                    <TreeView x:Name="ObjectTreeView"
                              ItemsSource="{Binding ObjectTree.Groups}" Margin="5"
                              SelectionMode="Single"
                              SelectionChanged="OnTreeViewSelectionChanged">
                        <TreeView.DataTemplates>
                            <!-- 群組模板 -->
                            <TreeDataTemplate DataType="{x:Type vm:ObjectGroupViewModel}"
                                              ItemsSource="{Binding Items}">
                                <StackPanel Orientation="Horizontal" Spacing="5">
                                    <TextBlock Text="{Binding Name}" FontWeight="SemiBold"/>
                                    <TextBlock Text="{Binding VisibleCount, StringFormat='({0})'}"
                                               Foreground="Gray"/>
                                </StackPanel>
                            </TreeDataTemplate>
                            <!-- 項目模板 -->
                            <DataTemplate DataType="{x:Type vm:ObjectItemViewModel}">
                                <TextBlock Text="{Binding DisplayName}"/>
                            </DataTemplate>
                        </TreeView.DataTemplates>
                        <TreeView.Styles>
                            <Style Selector="TreeViewItem">
                                <Setter Property="IsExpanded" Value="True"/>
                            </Style>
                            <!-- 隱藏不可見的項目 -->
                            <Style Selector="TreeViewItem" x:DataType="vm:ObjectItemViewModel">
                                <Setter Property="IsVisible" Value="{Binding IsVisible}"/>
                            </Style>
                        </TreeView.Styles>
                    </TreeView>
                </DockPanel>
            </Border>

            <!-- 分隔線 -->
            <GridSplitter Grid.Column="1" Background="{DynamicResource SystemControlBackgroundChromeMediumLowBrush}"
                          ResizeDirection="Columns"/>

            <!-- 右側：MDI TabControl 區域 -->
            <Border Grid.Column="2" Padding="5">
                <Grid>
                    <!-- 空白提示 -->
                    <TextBlock Text="請從左側選擇物件，或使用選單開啟 SQL 查詢"
                               HorizontalAlignment="Center"
                               VerticalAlignment="Center"
                               Foreground="Gray"
                               FontSize="14"
                               IsVisible="{Binding !Documents.Count}"/>

                    <!-- MDI TabControl -->
                    <TabControl ItemsSource="{Binding Documents}"
                                SelectedItem="{Binding SelectedDocument}"
                                IsVisible="{Binding Documents.Count}">
                        <TabControl.Styles>
                            <Style Selector="TabItem">
                                <Setter Property="Padding" Value="10,6"/>
                            </Style>
                            <!-- 關閉按鈕樣式 -->
                            <Style Selector="Button.tab-close">
                                <Setter Property="Background" Value="Transparent"/>
                                <Setter Property="BorderThickness" Value="0"/>
                                <Setter Property="Padding" Value="4,2"/>
                                <Setter Property="Margin" Value="4,0,0,0"/>
                                <Setter Property="CornerRadius" Value="3"/>
                                <Setter Property="Opacity" Value="0.6"/>
                            </Style>
                            <Style Selector="Button.tab-close:pointerover">
                                <Setter Property="Background" Value="#40FF0000"/>
                                <Setter Property="Opacity" Value="1"/>
                            </Style>
                            <Style Selector="Button.tab-close:pressed">
                                <Setter Property="Background" Value="#80FF0000"/>
                            </Style>
                        </TabControl.Styles>
                        <TabControl.ItemTemplate>
                            <DataTemplate DataType="{x:Type vm:DocumentViewModel}">
                                <StackPanel Orientation="Horizontal" Spacing="6">
                                    <TextBlock Text="{Binding Icon}" FontSize="14" VerticalAlignment="Center"/>
                                    <TextBlock Text="{Binding Title}" VerticalAlignment="Center"/>
                                    <Button Classes="tab-close"
                                            Command="{Binding $parent[TabControl].((vm:MainWindowViewModel)DataContext).CloseDocumentCommand}"
                                            CommandParameter="{Binding}"
                                            IsVisible="{Binding CanClose}"
                                            ToolTip.Tip="關閉分頁 (Ctrl+W)">
                                        <TextBlock Text="✕" FontSize="12" VerticalAlignment="Center"/>
                                    </Button>
                                </StackPanel>
                            </DataTemplate>
                        </TabControl.ItemTemplate>
                        <TabControl.ContentTemplate>
                            <DataTemplate>
                                <ContentControl Content="{Binding}">
                                    <ContentControl.DataTemplates>
                                        <DataTemplate DataType="{x:Type vm:TableDetailDocumentViewModel}">
                                            <views:TableDetailDocumentView/>
                                        </DataTemplate>
                                        <DataTemplate DataType="{x:Type vm:SqlQueryDocumentViewModel}">
                                            <views:SqlQueryDocumentView/>
                                        </DataTemplate>
                                        <DataTemplate DataType="{x:Type vm:ColumnSearchDocumentViewModel}">
                                            <views:ColumnSearchDocumentView/>
                                        </DataTemplate>
                                        <DataTemplate DataType="{x:Type vm:BackupRestoreDocumentViewModel}">
                                            <views:BackupRestoreDocumentView/>
                                        </DataTemplate>
                                        <DataTemplate DataType="{x:Type vm:SchemaCompareDocumentViewModel}">
                                            <views:SchemaCompareDocumentView/>
                                        </DataTemplate>
                                    </ContentControl.DataTemplates>
                                </ContentControl>
                            </DataTemplate>
                        </TabControl.ContentTemplate>
                    </TabControl>
                </Grid>
            </Border>
        </Grid>
    </DockPanel>
</Window>
